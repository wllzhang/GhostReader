name: CI

on:
    push:
        branches: [main, master, develop]
        paths-ignore:
            - "docs/**"
            - "**.md"
    pull_request:
        branches: [main, master, develop]
        paths-ignore:
            - "docs/**"
            - "**.md"

jobs:
    test:
        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
                node-version: [20.x]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run linter
              run: npm run lint:check

            - name: Run type check
              run: npm run compile

            - name: Run tests (Linux)
              if: runner.os == 'Linux'
              run: xvfb-run -a npm test

            - name: Run tests (Windows/macOS)
              if: runner.os != 'Linux'
              run: npm test

            - name: Build extension
              run: npm run build

            - name: Package extension
              run: npm run package

            - name: Upload VSIX artifact
              uses: actions/upload-artifact@v4
              if: matrix.os == 'ubuntu-latest'
              with:
                  name: vsix-package
                  path: "*.vsix"
                  retention-days: 7

